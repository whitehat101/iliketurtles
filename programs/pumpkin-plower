-- this script farms a very spicific (non-optimal) pumpkin farm with 3 pumpkins

os.loadAPI('/iliketurtles/apis/travel')
os.loadAPI('/iliketurtles/apis/refuel')
local inventory = {
  pumpkin = 1,
  empty = 13,
  pick = 14,
  hoe = 15,
  fuel = 16,
}
orientation.autoCalibrate()
turtle.back()
refuel.fromEnderChest(inventory.fuel)

assert(#{...} == 8, "Incorrect Parameters.\n"..
  "Usage: pumpkin-plower heading0, x0, y0, z0, headingS, xS, yS, zS\n" ..
  "                               origin                 storage")
local heading, x0, y0, z0, storageHeading, xS, yS, zS = ...
local origin = vector.new(x0, y0, z0)
local storage = vector.new(xS, yS, zS)

-- Main Farming Routines
local activeTool
local function with(item, callback)
  local prevItem = turtle.getSelectedSlot()

  -- equip requested tool
  if activeTool ~= item then
    turtle.select(inventory[activeTool])
    assert(turtle.equipLeft())

    turtle.select(inventory[item])
    assert(turtle.equipLeft())
    activeTool = item
  end

  -- restore inventory before callback
  turtle.select(prevItem)
  return callback()
end

local function ensure(callback)
  local ret
  repeat ret = {callback()} until ret[1]
  return unpack(ret)
end

function farmField()
  travel.goYthenXZ(origin)
  orientation.turn(heading)

  local unregister = turtle.forward.success(function()
    if turtle.detectDown() then
      with('pick', turtle.digDown)
    end
    with('hoe', turtle.digDown)
  end)

  for loop=1, 3 do
    ensure(turtle.forward)
    for cnt=1, 4 do
      ensure(turtle.forward)
      ensure(turtle.forward)
      if cnt ~= 4 then
        turtle.turnRight()
      end
    end
  end

  unregister()
end

function deposit()
  travel.goXZthenY(storage)
  orientation.turn(storageHeading)
  redstone.setOutput('front', true)
  turtle.drop()
  redstone.setOutput('front', false)
end

local function unequip()
    turtle.select(inventory.empty)
    if turtle.getItemCount() > 0 then
      turtle.drop()
    end
    turtle.equipLeft()
    if turtle.getItemCount() == 1 then
      if turtle.getItemCount(inventory.hoe) == 0 then
        turtle.transferTo(inventory.hoe)
      elseif turtle.getItemCount(inventory.pick) == 0 then
        turtle.transferTo(inventory.pick)
      else
        print('wtf? please reset inventory')
        while true do turtle.turnRight() end
      end
    end
    activeTool = 'empty'
end

-- Main "Event" Loop
print(
  "pumpkin-farmer\n"..
  'origin: '..origin:tostring()..' '..heading.."\n"..
  'storage: '..storage:tostring()..' '..storageHeading.."\n"..
  'Inventory:'
)
for item, slot in pairs(inventory) do print('- '..slot..' '..item) end

unequip()
turtle.select(inventory.pumpkin)
while true do
  farmField()
  if turtle.getItemCount() >= 32 then
    deposit()
  end
end
